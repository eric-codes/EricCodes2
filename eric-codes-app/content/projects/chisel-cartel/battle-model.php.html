<?php 

/**
*
* Code snippets from the model that controls
* individual battle data and handling &
* integration into WP REST API.
*
* Sensitive code redacted.
* 
*/
class Battles {
	
	function __construct() {
		add_action( 'admin_init',array( $this, 'AddAdminMeta' ) );
		add_action( 'admin_init', array($this,'AddFeaturedCategory') );
		add_action( 'init', array($this,'AddDatabase') );

		add_action( 'rest_api_init', array($this,'AddRESTData') );
	}

	function AddAdminMeta(){
		add_meta_box('battle-data', "Battle Data", array($this,'BattleDataOutput'), 'battle', 'normal' );
		add_action('save_post', array($this,'SaveBattleData'), 1, 2);
	}

	function AddRESTData(){

		register_rest_field( 'battle',
			'scoreboard',
			array(
				'get_callback'    => array($this,'REST_ReturnScoreboard'),
				'update_callback' => null, 
				'schema'          => null,
				)
			);
		register_rest_field( 'battle',
			'battle_meta',
			array(
				'get_callback'    => array($this,'REST_ReturnBattleMeta'),
				'update_callback' => null, 
				'schema'          => null,
				)
			);
		register_rest_route( 'battle-system/v1', 
			'/battles/get-all', 
			array(
				'methods' => 'GET',
				'callback' => array($this,'REST_GetAllBattles'),
				) 
			);
		register_rest_route( 'battle-system/v1', 
			'/battle', 
			array(
				'methods' => 'GET',
				'callback' => array($this,'REST_RetrieveBattle'),
				)
			);
		register_rest_route( 'battle-system/v1', 
			'/battle/get-id-by-slug', 
			array(
				'methods' => 'GET',
				'callback' => array($this,'REST_GetIDBySlug'),
				)
			);
	}

	function REST_RetrieveBattle($request) {
		global $wpdb;

		$parameters = $request->get_params();

		$ConstructQuery = "SELECT * FROM wp_posts 
		WHERE post_name LIKE '".$request['slug']."' 
		AND post_type LIKE 'battle'";	

		$PostID = get_page_by_path( $request['slug'], OBJECT, 'battle' );

		$BattleMeta = $this->REST_ReturnBattleMeta(array(
			'id' => $PostID->ID
			));

		$Scores = $this->REST_ReturnScoreboard(array(
			'id' => $PostID->ID
			));

		$ReturnArr = array(
			'post' => $PostID,
			'meta' => $BattleMeta,
			'scoreboard' => $Scores
			);

		return $ReturnArr;

	}



	function REST_GetAllBattles($request){
		global $wpdb;

		$parameters = $request->get_url_params();

		$ConstructQuery = "SELECT * FROM wp_posts 
		WHERE post_status LIKE 'publish'
		AND post_type LIKE 'battle'";

		$GetResults = $wpdb->get_results($ConstructQuery,OBJECT);

		$returnResults = array();

		foreach ($GetResults as $index => $battle) {
			$returnVal = $battle;

			$returnVal->dates = array(
				'battle' => get_post_meta( $battle->ID , 'battle_end_date', true ),
				'vote' => get_post_meta( $battle->ID , 'voting_end_date', true )
				);

			$returnVal->image = get_the_post_thumbnail_url( $battle->ID, 'large');
			$returnVal->thumb = get_the_post_thumbnail_url( $battle->ID, 'small');

			$battleCheck = time() - strtotime($returnVal->dates['battle']);
			$voteCheck = time() - strtotime($returnVal->dates['vote']);

			if ($battleCheck < 0) {
				$returnVal->status = "open";
			} else if ($voteCheck < 0) {
				$returnVal->status = "voting";
			} else {
				$returnVal->status = "closed";
			}

			$returnResults[$index] = $returnVal;
		}

		return $returnResults;

	}

	function AddDatabase() {
		global $wpdb;

		$CheckTable = $wpdb->query("
			SELECT 1 FROM wp_cc_votes LIMIT 1
			");

		if ($CheckTable == FALSE) {
			$CreateTable = $wpdb->query("
				CREATE TABLE wp_cc_votes (
				id INT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
				uid CHAR(10),
				battle_id INT(10) UNSIGNED NOT NULL,
				winner INT(10) UNSIGNED,
				loser INT(10) UNSIGNED,
				draw TEXT(20),
				`time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
				KEY (id)
				)
				");
		}

	}

	function Admin_CreateNonce(){
		echo '<input type="hidden" name="battle_noncename" id="battle_noncename" value="' .
		wp_create_nonce( plugin_basename(__FILE__) ) . '" />';
	}

	function BattleDataOutput(){
		?>
		<div class="battle-data">
			<?php
				// Create nonce
			$this->Admin_CreateNonce();

			$this->Admin_SetDates();
			$this->Admin_Prize_Section();

			?>
		</div>
		<?php

	}

	function AddFeaturedCategory(){
		$catCheck = get_category_by_slug('featured-battles');

		if (empty($catCheck)) {

			$cat_defaults = array(
				'cat_name' => 'Featured Battles',
				'category_nicename' => 'featured-battles',
				'taxonomy' => 'category' );

			$insertCheck = wp_insert_category( $cat_defaults, true );
			echo $insertCheck;
		}
	}

	function Admin_SetDates() {
		global $post;

		$BattleEndDate = get_post_meta( $post->ID, 'battle_end_date', true );
		$VotingEndDate = get_post_meta( $post->ID, 'voting_end_date', true );
		?>
		<div class="section set-dates">
			<div>
				<label for="battle_end_date">Battle End Date</label><br>
				<input type="date" name="battle_end_date" value="<?php echo $BattleEndDate; ?>">
			</div>
			<div>
				<label for="voting_end_date">Voting End Date</label><br>
				<input type="date" name="voting_end_date" value="<?php echo $VotingEndDate; ?>">
			</div>
		</div>
		<?
	}

	function Admin_Prize_Section(){
		global $post;

		$PrizeDetails = get_post_meta( $post->ID, 'prize_details', true );

		?>
		<div class="section prize-details">
			<h2>Prize Details</h2>
			<?php wp_editor( $PrizeDetails, 'prize_details' ); ?>
		</div>
		<?
	}

	function SaveBattleData(){


		global $post;

		if ( !wp_verify_nonce( $_POST['battle_noncename'], plugin_basename(__FILE__) )) {
			return $post->ID;
		}

		if ( !current_user_can( 'edit_post', $post->ID ))
			return $post->ID;



		$battle_meta['battle_end_date'] = $_POST['battle_end_date'];
		$battle_meta['voting_end_date'] = $_POST['voting_end_date'];

		$battle_meta['prize_details'] = $_POST['prize_details'];


		foreach ($battle_meta as $key => $value) { // Cycle through the $battle_meta array!
			if( $post->post_type == 'revision' ) return; // Don't store custom data twice
			$value = implode(',', (array)$value); // If $value is an array, make it a CSV (unlikely)
			if(get_post_meta($post->ID, $key, FALSE)) { // If the custom field already has a value
				update_post_meta($post->ID, $key, $value);
			} else { // If the custom field doesn't have a value
			add_post_meta($post->ID, $key, $value);
		}
			if(!$value) delete_post_meta($post->ID, $key); // Delete if blank
		}

	}

	function REST_ReturnScoreboard( $object, $field_name, $request ){
		$postID = $object['id'];

		$returnArr = array();

		$getEntries = get_posts( array(
			'posts_per_page' => 500,
			'orderby' => 'date',
			'order' => 'DESC',
			'meta_key' => 'battle_parent',
			'meta_value' => $postID,
			'post_type' => 'entry'
			) );

		foreach ($getEntries as $key => $value) {
			$return = array(
				'ID' => $value->ID,
				'name' => $value->post_title,
				'score' => array(
					'won' => get_post_meta( $value->ID, 'won', true ),
					'lost' => get_post_meta( $value->ID, 'lost', true ),
					'drawn' => get_post_meta( $value->ID, 'drawn', true ),
					),
				'assets' => array(
					'battle_photo' => wp_get_attachment_image_src( get_post_thumbnail_id($value->ID), "full"),
					'battle_thumb' => wp_get_attachment_image_src( get_post_thumbnail_id($value->ID), "thumbnail"),
					)
				);

			$return['score']['shown'] = intval($return['score']['won']) + intval($return['score']['lost']) + intval($return['score']['drawn']);

			$return['score']['win_percentage'] = ((intval($return['score']['won']) * 100) / intval($return['score']['shown']));

			$returnArr[$key] = $return;

		}

		return $returnArr;

	}

	function REST_ReturnBattleMeta($object,$field_name,$request) {
		$postID = $object['id'];

		$returnArr = array();

		$returnArr['battle_end_date'] = get_post_meta( $postID, 'battle_end_date', true );
		$returnArr['voting_end_date'] = get_post_meta( $postID, 'voting_end_date', true );

		$returnArr['prize_details'] = get_post_meta( $postID, 'prize_details', true );
		$returnArr['photo'] = wp_get_attachment_image_src( get_post_thumbnail_id($postID), "full");
		$returnArr['thumbnail'] = wp_get_attachment_image_src( get_post_thumbnail_id($postID), "thumbnail");
		
		$battleCheck = time() - strtotime($returnArr['battle_end_date']);
		$voteCheck = time() - strtotime($returnArr['voting_end_date']);

		if ($battleCheck < 0) {
			$returnArr['status'] = "open";
		} else if ($voteCheck < 0) {
			$returnArr['status'] = "voting";
		} else {
			$returnArr['status'] = "closed";
		}

		return $returnArr;
	}

	function REST_GetIDBySlug($request) {
		global $wpdb;

		$parameters = $request->get_params();

		$PostID = get_page_by_path( $request['slug'], OBJECT, 'battle' );

		return $PostID->ID;
	}
}

$Battles = new Battles();




?>